# üè¶ Sistema de Gesti√≥n de Cuentas Bancarias ‚Äî `banking-account-service`

---

# 1Ô∏è‚É£ Configuraci√≥n inicial del proyecto (application.yml + Flyway)

---

## üê≥ Configuraci√≥n de la Base de Datos PostgreSQL en Docker

Para facilitar el desarrollo y mantener un entorno aislado, configuramos un contenedor de `PostgreSQL` usando
`Docker Compose`. Esto nos permite levantar la base de datos de manera reproducible en cualquier m√°quina, sin necesidad
de instalar `PostgreSQL` directamente en el sistema operativo.

Este archivo se crea en la ra√≠z de este repositorio: `docker/compose.yml`.

````yml
services:
  s-postgres-hexagonal:
    image: postgres:17-alpine
    container_name: c-postgres-hexagonal
    restart: unless-stopped
    ports:
      - '5435:5432'
    environment:
      POSTGRES_DB: db_hexagonal
      POSTGRES_USER: magadiflo
      POSTGRES_PASSWORD: magadiflo
    volumes:
      - postgres-hexagonal-data:/var/lib/postgresql/data
    networks:
      - hexagonal-net

volumes:
  postgres-hexagonal-data:
    name: postgres-hexagonal-data

networks:
  hexagonal-net:
    name: hexagonal-net
````

## Dependencias

En esta primera etapa iniciamos creando el proyecto `banking-account-service` a trav√©s de
[Spring Initializr (ver dependencias)](https://start.spring.io/#!type=maven-project&language=java&platformVersion=4.0.3&packaging=jar&configurationFileFormat=yaml&jvmVersion=25&groupId=dev.magadiflo.banking.app&artifactId=banking-account-service&name=banking-account-service&description=Demo%20project%20for%20Spring%20Boot&packageName=dev.magadiflo.banking.app&dependencies=web,data-jpa,validation,postgresql,flyway,lombok)
donde seleccionamos las dependencias necesarias para constuir un servicio bancario robusto.

La √∫nica dependencia agregada manualmente fue `MapStruct`, junto con su `plugin` para facilitar la generaci√≥n de mapeos
entre objetos.

````xml
<!--Spring Boot 4.0.3-->
<!--Java 25-->
<!--org.mapstruct.version 1.6.3-->
<!--lombok-mapstruct-binding.version 0.2.0-->
<dependencies>
    <!-- ===== SPRING BOOT ===== -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-webmvc</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>

    <!-- ===== BASE DE DATOS ===== -->
    <dependency>
        <groupId>org.postgresql</groupId>
        <artifactId>postgresql</artifactId>
        <scope>runtime</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-flyway</artifactId>
    </dependency>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-database-postgresql</artifactId>
    </dependency>

    <!-- ===== MAPSTRUCT ===== -->
    <dependency>
        <groupId>org.mapstruct</groupId>
        <artifactId>mapstruct</artifactId>
        <version>${org.mapstruct.version}</version>
    </dependency>

    <!-- ===== LOMBOK ===== -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>

    <!-- ===== TESTING ===== -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa-test</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-flyway-test</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation-test</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-webmvc-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
````

### üîé Explicaci√≥n de las dependencias

- `spring-boot-starter-data-jpa` ‚Üí Proporciona integraci√≥n con JPA/Hibernate, ideal para manejar entidades y
  repositorios.
- `spring-boot-starter-webmvc` ‚Üí Permite construir APIs REST usando el modelo MVC.
- `spring-boot-starter-validation` ‚Üí A√±ade soporte para validaciones con anotaciones como `@NotNull`, `@Size`, etc.
- `postgresql` ‚Üí Driver JDBC para conectarse a la base de datos PostgreSQL.
- `flyway` ‚Üí Herramienta de migraci√≥n de base de datos, asegura que el esquema evolucione de forma controlada.
- `mapstruct` ‚Üí Generador de mapeos entre DTOs y entidades, evitando c√≥digo repetitivo.
- `lombok` ‚Üí Reduce el boilerplate con anotaciones como `@Getter`, `@Builder`, etc.
- `testing starters` ‚Üí Facilitan pruebas unitarias e integraci√≥n para cada m√≥dulo (JPA, Flyway, Web, Validation).

### ‚öôÔ∏è Configuraci√≥n de Plugins

Los plugins en el `pom.xml` permiten que el proyecto compile correctamente y procese anotaciones.

- `maven-compiler-plugin` ‚Üí Define la versi√≥n de Java y gestiona los annotation processors.
    - Aqu√≠ se incluyen `Lombok` y `MapStruct`, que generan c√≥digo autom√°ticamente durante la compilaci√≥n.
- `spring-boot-maven-plugin` ‚Üí Empaqueta la aplicaci√≥n como un `fat JAR` ejecutable y permite correrla con
  `mvn spring-boot:run`.
    - La exclusi√≥n de Lombok evita conflictos en tiempo de ejecuci√≥n, ya que Lombok solo es necesario en compilaci√≥n.

````xml

<build>
    <plugins>
        <!--MapStruct-->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <version>${maven-compiler-plugin.version}</version>
            <configuration>
                <source>${java.version}</source>
                <target>${java.version}</target>
                <annotationProcessorPaths>
                    <path>
                        <groupId>org.projectlombok</groupId>
                        <artifactId>lombok</artifactId>
                        <version>${lombok.version}</version>
                    </path>
                    <path>
                        <groupId>org.mapstruct</groupId>
                        <artifactId>mapstruct-processor</artifactId>
                        <version>${org.mapstruct.version}</version>
                    </path>
                    <path>
                        <groupId>org.projectlombok</groupId>
                        <artifactId>lombok-mapstruct-binding</artifactId>
                        <version>${lombok-mapstruct-binding.version}</version>
                    </path>
                </annotationProcessorPaths>
            </configuration>
        </plugin>
        <!--/MapStruct-->
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
            <configuration>
                <excludes>
                    <exclude>
                        <groupId>org.projectlombok</groupId>
                        <artifactId>lombok</artifactId>
                    </exclude>
                </excludes>
            </configuration>
        </plugin>
    </plugins>
</build>
````

## ‚öôÔ∏è Configuraciones en el application.yml

En esta secci√≥n definimos las propiedades de configuraci√≥n del servicio `banking-account-service`, centralizando
par√°metros de servidor, base de datos, migraciones y servicios externos.

````yml
server:
  port: 8080
  error:
    include-message: always

spring:
  application:
    name: banking-account-service

  # API Versioning (Spring Boot 4)
  mvc:
    api-version:
      required: true
      supported: 1,2
      use:
        path-segment: 1

  datasource:
    url: jdbc:postgresql://localhost:5435/db_hexagonal
    username: magadiflo
    password: magadiflo

  jpa:
    hibernate:
      ddl-auto: validate    # validate: hibernate solo valida el schema, Flyway es quien lo crea
    properties:
      hibernate:
        format_sql: true

  flyway:
    baseline-on-migrate: true
    validate-on-migrate: true
    enabled: true
    locations: classpath:db/migration
    baseline-description: 'init'
    baseline-version: 0

# ===== Configuraci√≥n personalizada del servicio externo (ExchangeRate API) =====
exchange-rate:
  api:
    base-url: https://v6.exchangerate-api.com/v6
    api-key: YOUR_API_KEY_HERE     # Reemplazar con el API key real
    timeout-seconds: 5

logging:
  level:
    dev.magadiflo: debug
    org.hibernate.SQL: debug
    org.flywaydb: info
````

- `spring.mvc.api-version`: En `Spring Boot 4`, se ha introducido el soporte nativo para el versionamiento de APIs
  directamente en el n√∫cleo de `spring-mvc`.
    - `required: true`: Obliga a que todas las peticiones incluyan una versi√≥n. Si el cliente no la env√≠a, la solicitud
      fallar√° (generalmente con un 400 Bad Request).
    - `supported: 1,2`: Define qu√© versiones son v√°lidas en tu aplicaci√≥n. En este caso, solo aceptar√° peticiones
      marcadas como versi√≥n 1 o 2.
    - `use.path-segment: 1`: Indica que la versi√≥n se debe extraer de un segmento de la ruta (URL). El valor `1` es el
      √≠ndice del segmento de ruta donde se espera la versi√≥n. Por ejemplo:
        - Para una estructura de URL como `/{versi√≥n}/resource`, use `0`.
        - Para una estructura de URL como `/api/{versi√≥n}/resource`, use `1` (nuestro caso).
- `hibernate.ddl-auto: validate` ‚Üí Hibernate solo valida que el esquema de la BD coincida con las entidades.
    - No crea ni modifica tablas.
    - La responsabilidad de migraciones recae en `Flyway` (buena pr√°ctica en entornos productivos).

- `spring.flyway`
    - `baseline-on-migrate: true` ‚Üí Permite inicializar la base de datos con una versi√≥n base cuando ya existen tablas.
    - `validate-on-migrate: true` ‚Üí Verifica que las migraciones aplicadas coincidan con el historial esperado.
    - `enabled: true` ‚Üí Activa `Flyway` en la aplicaci√≥n.
    - `locations: classpath:db/migration` ‚Üí Carpeta donde se ubican los scripts SQL de migraci√≥n.
    - `baseline-description: 'init'` ‚Üí Descripci√≥n de la versi√≥n inicial.
    - `baseline-version: 0` ‚Üí Define la versi√≥n base de la migraci√≥n.

## üõ†Ô∏è Creando archivos SQL para usar con Flyway

> **‚ö†Ô∏è Nota.** En el siguiente repositorio tambi√©n se hace uso de Flyway:
> [microservices-e-commerce](https://github.com/magadiflo/microservices-e-commerce/tree/main/business-domain/product-service)

Cuando agregamos la dependencia de `Flyway` desde `Spring Initializr`, autom√°ticamente se crea el directorio:
`src/main/resources/db/migration`. Dentro de este directorio colocaremos todos los scripts `.sql` que `Flyway`
ejecutar√° en orden secuencial.

üëâ Importante:
> Aunque usamos `JPA/Hibernate`, la configuraci√≥n `ddl-auto: validate` hace que `Hibernate` solo `valide el esquema`
> existente contra las entidades, pero `no lo cree ni lo actualice`. La responsabilidad de crear y evolucionar la base
> de datos recae en `Flyway`, lo cual es la pr√°ctica recomendada en entornos productivos.

### üìë Convenci√≥n de nombres en Flyway

`Flyway` utiliza una `convenci√≥n estricta de nombres` para identificar y ejecutar las migraciones en orden.
Cada archivo debe seguir el formato:

````bash
V<versi√≥n>__<descripcion>.sql 
````

- `V` ‚Üí Indica que es una migraci√≥n de versi√≥n (Versioned Migration).
- `<versi√≥n>` ‚Üí N√∫mero incremental que define el orden de ejecuci√≥n (ejemplo: 1, 2, 3 ‚Ä¶).
- `__` (doble guion bajo) ‚Üí Separador obligatorio entre la versi√≥n y la descripci√≥n.
- `<descripcion>` ‚Üí Texto descriptivo en min√∫sculas y con guiones bajos, que explica la acci√≥n del script
  (ejemplo: `create_customers_table`).
- `.sql` ‚Üí Extensi√≥n del archivo, ya que `Flyway` ejecuta directamente scripts `SQL`.

````bash
V1__create_customers_table.sql
V2__create_accounts_table.sql
V3__create_transactions_table.sql
````

### üìÑ Script: V1__create_customers_table.sql

Ruta del archivo:

````bash
src/main/resources/db/migration/V1__create_customers_table.sql
````

````sql
-- V1: Creaci√≥n de la tabla customers
CREATE TABLE customers
(
    id              BIGSERIAL    NOT NULL, --Clave interna(PK): usado para joins, FK en otras tablas, √≠ndices, etc.
    customer_code   VARCHAR(20)  NOT NULL, --Referencia de negocio, la que viaja en la API, URLs, respuestas JSON
    document_number VARCHAR(20)  NOT NULL,
    document_type   VARCHAR(10)  NOT NULL,
    first_name      VARCHAR(100) NOT NULL,
    last_name       VARCHAR(100) NOT NULL,
    email           VARCHAR(150) NOT NULL,
    phone           VARCHAR(20)  NOT NULL,
    status          VARCHAR(20)  NOT NULL DEFAULT 'ACTIVE',
    created_at      TIMESTAMP    NOT NULL DEFAULT now(),
    updated_at      TIMESTAMP    NOT NULL DEFAULT now(),

    CONSTRAINT pk_customers PRIMARY KEY (id),
    CONSTRAINT uq_customers_customer_code UNIQUE (customer_code),
    CONSTRAINT uq_customers_document_number UNIQUE (document_number),
    CONSTRAINT uq_customers_email UNIQUE (email),
    CONSTRAINT chk_customers_document_type CHECK (document_type IN ('DNI', 'RUC', 'PASAPORTE')),
    CONSTRAINT chk_customers_status CHECK (status IN ('ACTIVE', 'INACTIVE', 'BLOCKED'))
);

-- √çndices para b√∫squedas frecuentes
-- Nota: document_number y email ya tienen √≠ndices por sus restricciones UNIQUE
CREATE INDEX idx_customers_status ON customers (status);

COMMENT
ON TABLE customers IS 'Tabla de clientes del banco';
COMMENT
ON COLUMN customers.id IS 'Primary Key: usado para joins, FK, √≠ndices, etc.';
COMMENT
ON COLUMN customers.customer_code IS 'Referencia de negocio, la que viaja en la API, URLs, respuestas JSON';
COMMENT
ON COLUMN customers.document_number IS 'N√∫mero de documento de identidad';
COMMENT
ON COLUMN customers.document_type IS 'Tipo de documento: DNI, RUC, PASAPORTE';
COMMENT
ON COLUMN customers.status IS 'Estado del cliente: ACTIVE, INACTIVE, BLOCKED';
````

### üìÑ Script: V2__create_accounts_table.sql

Ruta del archivo:

````bash
src/main/resources/db/migration/V2__create_accounts_table.sql
````

````sql
-- V2: Creaci√≥n de la tabla accounts
CREATE TABLE accounts
(
    id             BIGSERIAL      NOT NULL,                        --Clave interna(PK): usado para joins, FK en otras tablas, √≠ndices, etc.
    account_number VARCHAR(20)    NOT NULL,                        --Referencia de negocio, la que viaja en la API, URLs, respuestas JSON
    customer_id    BIGINT         NOT NULL,                        --FK hacia customers.id
    account_type   VARCHAR(20)    NOT NULL,
    balance        DECIMAL(19, 2) NOT NULL DEFAULT 0.00,
    currency       VARCHAR(3)     NOT NULL DEFAULT 'PEN',
    status         VARCHAR(20)    NOT NULL DEFAULT 'ACTIVE',
    created_at     TIMESTAMP      NOT NULL DEFAULT now(),
    updated_at     TIMESTAMP      NOT NULL DEFAULT now(),

    CONSTRAINT pk_accounts PRIMARY KEY (id),                       -- PK crea √≠ndice √∫nico autom√°ticamente
    CONSTRAINT uq_accounts_account_number UNIQUE (account_number), -- UNIQUE crea √≠ndice √∫nico autom√°ticamente

    -- ON DELETE RESTRICT: Impide borrar un cliente si existen cuentas asociadas que lo referencian.
    -- Garantiza la integridad referencial.
    -- Nota: es muy parecido a NO ACTION (que es el valor por defecto), pero la diferencia es que RESTRICT
    -- valida inmediatamente la restricci√≥n en el momento de ejecutar la sentencia, mientras que NO ACTION
    -- espera hasta el final de la transacci√≥n para comprobarla.
    CONSTRAINT fk_accounts_customer FOREIGN KEY (customer_id)
        REFERENCES customers (id) ON DELETE RESTRICT,

    CONSTRAINT chk_accounts_balance CHECK (balance >= 0),
    CONSTRAINT chk_accounts_account_type CHECK (account_type IN ('SAVINGS', 'CHECKING')),
    CONSTRAINT chk_accounts_currency CHECK (currency IN ('PEN', 'USD', 'EUR')),
    CONSTRAINT chk_accounts_status CHECK (status IN ('ACTIVE', 'INACTIVE', 'BLOCKED', 'CLOSED'))
);

-- √çndices para b√∫squedas frecuentes
CREATE INDEX idx_accounts_customer_id ON accounts (customer_id); -- Creamos √≠ndice de customer_id, porque el FK no crea √≠ndice autom√°tico
CREATE INDEX idx_accounts_status ON accounts (status); -- √∫til para filtrar cuentas por estado

COMMENT
ON TABLE accounts IS 'Tabla de cuentas bancarias';
COMMENT
ON COLUMN accounts.id IS 'Primary Key: usado para joins, FK, √≠ndices, etc.';
COMMENT
ON COLUMN accounts.account_number IS 'Referencia de negocio, la que viaja en la API, URLs, respuestas JSON';
COMMENT
ON COLUMN accounts.customer_id IS 'Cliente propietario de la cuenta (FK hacia customers.id)';
COMMENT
ON COLUMN accounts.account_type IS 'Tipo de cuenta: SAVINGS (ahorros), CHECKING (corriente)';
COMMENT
ON COLUMN accounts.balance IS 'Saldo actual de la cuenta con 2 decimales';
COMMENT
ON COLUMN accounts.currency IS 'Moneda de la cuenta: PEN, USD, EUR';
COMMENT
ON COLUMN accounts.status IS 'Estado: ACTIVE, INACTIVE, BLOCKED, CLOSED';
````

### üìÑ Script: V3__create_transactions_table.sql

Ruta del archivo:

````bash
src/main/resources/db/migration/V3__create_transactions_table.sql
````

````sql
-- V3: Creaci√≥n de la tabla transactions
CREATE TABLE transactions
(
    id               BIGSERIAL      NOT NULL, --Clave interna(PK): usado para joins, FK en otras tablas, √≠ndices, etc.
    reference_number VARCHAR(50)    NOT NULL, --Referencia de negocio, la que viaja en la API, URLs, respuestas JSON
    account_id       BIGINT         NOT NULL, --FK hacia accounts.id
    transaction_type VARCHAR(20)    NOT NULL,
    amount           DECIMAL(19, 2) NOT NULL,
    currency         VARCHAR(3)     NOT NULL,
    description      VARCHAR(255),
    status           VARCHAR(20)    NOT NULL DEFAULT 'PENDING',
    created_at       TIMESTAMP      NOT NULL DEFAULT now(),

    CONSTRAINT pk_transactions PRIMARY KEY (id),
    CONSTRAINT uq_transactions_reference_number UNIQUE (reference_number),
    CONSTRAINT fk_transactions_account FOREIGN KEY (account_id)
        REFERENCES accounts (id) ON DELETE RESTRICT,
    CONSTRAINT chk_transactions_amount CHECK (amount > 0),
    CONSTRAINT chk_transactions_type CHECK (transaction_type IN
                                            ('DEPOSIT', 'WITHDRAWAL', 'TRANSFER_IN', 'TRANSFER_OUT')),
    CONSTRAINT chk_transactions_currency CHECK (currency IN ('PEN', 'USD', 'EUR')),
    CONSTRAINT chk_transactions_status CHECK (status IN ('PENDING', 'COMPLETED', 'FAILED'))
);

-- √çndices para b√∫squedas frecuentes
CREATE INDEX idx_transactions_account_id ON transactions (account_id); -- Creamos √≠ndice de account_id, porque el FK no crea √≠ndice autom√°tico
CREATE INDEX idx_transactions_type ON transactions (transaction_type);
CREATE INDEX idx_transactions_status ON transactions (status);
CREATE INDEX idx_transactions_created_at ON transactions (created_at DESC);

COMMENT
ON TABLE transactions IS 'Tabla de movimientos/transacciones bancarias';
COMMENT
ON COLUMN transactions.id IS 'Primary Key: usado para joins, FK, √≠ndices, etc.';
COMMENT
ON COLUMN transactions.reference_number IS 'Referencia de negocio, la que viaja en la API, URLs, respuestas JSON';
COMMENT
ON COLUMN transactions.account_id IS 'Cuenta bancaria asociada a la transacci√≥n (FK hacia accounts.id)';
COMMENT
ON COLUMN transactions.transaction_type IS 'Tipo: DEPOSIT, WITHDRAWAL, TRANSFER_IN, TRANSFER_OUT';
COMMENT
ON COLUMN transactions.amount IS 'Monto de la operaci√≥n, siempre positivo';
COMMENT
ON COLUMN transactions.status IS 'Estado: PENDING, COMPLETED, FAILED';
````

## üê≥ Levantando contenedor de base de datos PostgreSQL

Una vez definido el archivo `compose.yml` en la ra√≠z de este repositorio, podemos levantar el contenedor de
`PostgreSQL` con el siguiente comando:

````bash
D:\programming\spring\15.martin_diaz\hexagonal-architecture (main -> origin)
$ docker compose -f ./docker/compose.yml up -d                              
[+] up 3/3                                                                  
 ‚úî Network hexagonal-net          Created                                   
 ‚úî Volume postgres-hexagonal-data Created                                   
 ‚úî Container c-postgres-hexagonal Created                                   
````

üìå El par√°metro `-d` indica que el contenedor se ejecutar√° en `modo detached`, es decir, en segundo plano.

### üîé Verificaci√≥n del contenedor

Podemos verificar que el contenedor se haya levantado correctamente con:

````bash
$ docker container ls -a                                                                                                                                        
CONTAINER ID   IMAGE                COMMAND                  CREATED          STATUS          PORTS                                         NAMES               
0b7aa5d7d838   postgres:17-alpine   "docker-entrypoint.s‚Ä¶"   42 seconds ago   Up 40 seconds   0.0.0.0:5435->5432/tcp, [::]:5435->5432/tcp   c-postgres-hexagonal 
````

## üöÄ Ejecuta aplicaci√≥n e inicia migraci√≥n con Flyway

Cuando una aplicaci√≥n est√° completamente desarrollada, el flujo de ejecuci√≥n entre `Flyway` y `JPA/Hibernate`
sigue este orden:

````
Flyway ejecuta los .sql  ‚Üí  tablas creadas en BD
         +
Entidades JPA creadas    ‚Üí  Hibernate las escanea
         +
ddl-auto: validate       ‚Üí  Hibernate compara entidades vs tablas
         ‚Üì
‚úÖ Todo coincide ‚Üí aplicaci√≥n arranca correctamente 
````

üëâ En nuestro caso, ya tenemos configuradas las propiedades de `Flyway` en el `application.yml` y creados los 3
archivos de migraci√≥n dentro de `/db/migration`. Esto es suficiente para ejecutar la aplicaci√≥n y comprobar
que `Flyway` aplica correctamente las migraciones.

### üìä Flujo actual de ejecuci√≥n

````
1. Spring Boot arranca
2. Flyway detecta los 3 scripts en classpath:db/migration
3. Flyway ejecuta V1 ‚Üí crea tabla customers
4. Flyway ejecuta V2 ‚Üí crea tabla accounts
5. Flyway ejecuta V3 ‚Üí crea tabla transactions
6. Hibernate escanea entidades ‚Üí no encuentra ninguna ‚Üí nada que validar
7. ‚úÖ Aplicaci√≥n arranca en puerto 8080 
````

> `Flyway` adem√°s crear√° autom√°ticamente su tabla interna `flyway_schema_history` donde registra qu√© scripts ya ejecut√≥,
> con su checksum, fecha y estado. Eso es lo que le permite saber que la pr√≥xima vez que arranques no vuelve a ejecutar
> los mismos scripts.

### üìú Ejemplo de logs de migraci√≥n

Al iniciar la aplicaci√≥n, veremos en consola la ejecuci√≥n de `Flyway`:

````bash
2026-02-26T11:13:33.354-05:00  INFO 17428 --- [banking-account-service] [           main] org.flywaydb.core.FlywayExecutor         : Database: jdbc:postgresql://localhost:5435/db_hexagonal (PostgreSQL 17.5)
2026-02-26T11:13:33.416-05:00  INFO 17428 --- [banking-account-service] [           main] o.f.c.i.s.JdbcTableSchemaHistory         : Schema history table "public"."flyway_schema_history" does not exist yet
2026-02-26T11:13:33.421-05:00  INFO 17428 --- [banking-account-service] [           main] o.f.core.internal.command.DbValidate     : Successfully validated 3 migrations (execution time 00:00.025s)
2026-02-26T11:13:33.443-05:00  INFO 17428 --- [banking-account-service] [           main] org.flywaydb.core.Flyway                 : All configured schemas are empty; baseline operation skipped. A baseline or migration script with a lower version than the baseline version may execute if available. Check the Schemas parameter if this is not intended.
2026-02-26T11:13:33.450-05:00  INFO 17428 --- [banking-account-service] [           main] o.f.c.i.s.JdbcTableSchemaHistory         : Creating Schema History table "public"."flyway_schema_history" ...
2026-02-26T11:13:33.523-05:00  INFO 17428 --- [banking-account-service] [           main] o.f.core.internal.command.DbMigrate      : Current version of schema "public": << Empty Schema >>
2026-02-26T11:13:33.541-05:00  INFO 17428 --- [banking-account-service] [           main] o.f.core.internal.command.DbMigrate      : Migrating schema "public" to version "1 - create customers table"
2026-02-26T11:13:33.690-05:00  INFO 17428 --- [banking-account-service] [           main] o.f.core.internal.command.DbMigrate      : Migrating schema "public" to version "2 - create accounts table"
2026-02-26T11:13:33.743-05:00  INFO 17428 --- [banking-account-service] [           main] o.f.core.internal.command.DbMigrate      : Migrating schema "public" to version "3 - create transactions table"
2026-02-26T11:13:33.797-05:00  INFO 17428 --- [banking-account-service] [           main] o.f.core.internal.command.DbMigrate      : Successfully applied 3 migrations to schema "public", now at version v3 (execution time 00:00.165s)
````

### üìë Tablas generadas

Al revisar la base de datos, veremos las tres tablas definidas en nuestros scripts (customers, accounts, transactions)
y la tabla adicional creada por `Flyway`:

- `customers`
- `accounts`
- `transactions`
- `flyway_schema_history` ‚Üê tabla interna de `Flyway`

![01.png](assets/01.png)

Ejemplo de consulta dentro del contenedor:

````bash
$ docker container exec -it c-postgres-hexagonal /bin/sh
/ # psql -U magadiflo -d db_hexagonal
psql (17.5)
Type "help" for help.

db_hexagonal=# \dt
                 List of relations
 Schema |         Name          | Type  |   Owner
--------+-----------------------+-------+-----------
 public | accounts              | table | magadiflo
 public | customers             | table | magadiflo
 public | flyway_schema_history | table | magadiflo
 public | transactions          | table | magadiflo
(4 rows)

db_hexagonal=# SELECT * FROM flyway_schema_history;
 installed_rank | version |        description        | type |              script               |  checksum   | installed_by |        installed_on        | execution_time | success
----------------+---------+---------------------------+------+-----------------------------------+-------------+--------------+----------------------------+----------------+---------
              1 | 1       | create customers table    | SQL  | V1__create_customers_table.sql    | -1632371591 | magadiflo    | 2026-02-26 11:13:33.557319 |            102 | t
              2 | 2       | create accounts table     | SQL  | V2__create_accounts_table.sql     |  -157056600 | magadiflo    | 2026-02-26 11:13:33.716706 |             33 | t
              3 | 3       | create transactions table | SQL  | V3__create_transactions_table.sql |  -593502464 | magadiflo    | 2026-02-26 11:13:33.780898 |             30 | t
(3 rows) 
````
