# üè¶ Sistema de Gesti√≥n de Cuentas Bancarias ‚Äî `banking-account-service`

---

# 1Ô∏è‚É£ Configuraci√≥n inicial del proyecto (application.yml + Flyway)

---

## Dependencias

En esta primera etapa iniciamos creando el proyecto `banking-account-service` a trav√©s de
[Spring Initializr (ver dependencias)](https://start.spring.io/#!type=maven-project&language=java&platformVersion=4.0.3&packaging=jar&configurationFileFormat=yaml&jvmVersion=25&groupId=dev.magadiflo.banking.app&artifactId=banking-account-service&name=banking-account-service&description=Demo%20project%20for%20Spring%20Boot&packageName=dev.magadiflo.banking.app&dependencies=web,data-jpa,validation,postgresql,flyway,lombok)
donde seleccionamos las dependencias necesarias para constuir un servicio bancario robusto.

La √∫nica dependencia agregada manualmente fue `MapStruct`, junto con su `plugin` para facilitar la generaci√≥n de mapeos
entre objetos.

````xml
<!--Spring Boot 4.0.3-->
<!--Java 25-->
<!--org.mapstruct.version 1.6.3-->
<!--lombok-mapstruct-binding.version 0.2.0-->
<dependencies>
    <!-- ===== SPRING BOOT ===== -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-webmvc</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>

    <!-- ===== BASE DE DATOS ===== -->
    <dependency>
        <groupId>org.postgresql</groupId>
        <artifactId>postgresql</artifactId>
        <scope>runtime</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-flyway</artifactId>
    </dependency>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-database-postgresql</artifactId>
    </dependency>

    <!-- ===== MAPSTRUCT ===== -->
    <dependency>
        <groupId>org.mapstruct</groupId>
        <artifactId>mapstruct</artifactId>
        <version>${org.mapstruct.version}</version>
    </dependency>

    <!-- ===== LOMBOK ===== -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>

    <!-- ===== TESTING ===== -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa-test</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-flyway-test</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation-test</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-webmvc-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
````

### üîé Explicaci√≥n de las dependencias

- `spring-boot-starter-data-jpa` ‚Üí Proporciona integraci√≥n con JPA/Hibernate, ideal para manejar entidades y
  repositorios.
- `spring-boot-starter-webmvc` ‚Üí Permite construir APIs REST usando el modelo MVC.
- `spring-boot-starter-validation` ‚Üí A√±ade soporte para validaciones con anotaciones como `@NotNull`, `@Size`, etc.
- `postgresql` ‚Üí Driver JDBC para conectarse a la base de datos PostgreSQL.
- `flyway` ‚Üí Herramienta de migraci√≥n de base de datos, asegura que el esquema evolucione de forma controlada.
- `mapstruct` ‚Üí Generador de mapeos entre DTOs y entidades, evitando c√≥digo repetitivo.
- `lombok` ‚Üí Reduce el boilerplate con anotaciones como `@Getter`, `@Builder`, etc.
- `testing starters` ‚Üí Facilitan pruebas unitarias e integraci√≥n para cada m√≥dulo (JPA, Flyway, Web, Validation).

### ‚öôÔ∏è Configuraci√≥n de Plugins

Los plugins en el `pom.xml` permiten que el proyecto compile correctamente y procese anotaciones.

- `maven-compiler-plugin` ‚Üí Define la versi√≥n de Java y gestiona los annotation processors.
    - Aqu√≠ se incluyen `Lombok` y `MapStruct`, que generan c√≥digo autom√°ticamente durante la compilaci√≥n.
- `spring-boot-maven-plugin` ‚Üí Empaqueta la aplicaci√≥n como un `fat JAR` ejecutable y permite correrla con
  `mvn spring-boot:run`.
    - La exclusi√≥n de Lombok evita conflictos en tiempo de ejecuci√≥n, ya que Lombok solo es necesario en compilaci√≥n.

````xml

<build>
    <plugins>
        <!--MapStruct-->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <version>${maven-compiler-plugin.version}</version>
            <configuration>
                <source>${java.version}</source>
                <target>${java.version}</target>
                <annotationProcessorPaths>
                    <path>
                        <groupId>org.projectlombok</groupId>
                        <artifactId>lombok</artifactId>
                        <version>${lombok.version}</version>
                    </path>
                    <path>
                        <groupId>org.mapstruct</groupId>
                        <artifactId>mapstruct-processor</artifactId>
                        <version>${org.mapstruct.version}</version>
                    </path>
                    <path>
                        <groupId>org.projectlombok</groupId>
                        <artifactId>lombok-mapstruct-binding</artifactId>
                        <version>${lombok-mapstruct-binding.version}</version>
                    </path>
                </annotationProcessorPaths>
            </configuration>
        </plugin>
        <!--/MapStruct-->
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
            <configuration>
                <excludes>
                    <exclude>
                        <groupId>org.projectlombok</groupId>
                        <artifactId>lombok</artifactId>
                    </exclude>
                </excludes>
            </configuration>
        </plugin>
    </plugins>
</build>
````

## ‚öôÔ∏è Configuraciones en el application.yml

En esta secci√≥n definimos las propiedades de configuraci√≥n del servicio `banking-account-service`, centralizando
par√°metros de servidor, base de datos, migraciones y servicios externos.

````yml
server:
  port: 8080
  error:
    include-message: always

spring:
  application:
    name: banking-account-service

  datasource:
    url: jdbc:postgresql://localhost:5435/db_hexagonal
    username: magadiflo
    password: magadiflo

  jpa:
    hibernate:
      ddl-auto: validate    # validate: hibernate solo valida el schema, Flyway es quien lo crea
    properties:
      hibernate:
        format_sql: true

  flyway:
    baseline-on-migrate: true
    validate-on-migrate: true
    enabled: true
    locations: classpath:db/migration
    baseline-description: 'init'
    baseline-version: 0

# ===== Configuraci√≥n personalizada del servicio externo (ExchangeRate API) =====
exchange-rate:
  api:
    base-url: https://v6.exchangerate-api.com/v6
    api-key: YOUR_API_KEY_HERE     # Reemplazar con el API key real
    timeout-seconds: 5

logging:
  level:
    dev.magadiflo: debug
    org.hibernate.SQL: debug
    org.flywaydb: info
````

- `hibernate.ddl-auto: validate` ‚Üí Hibernate solo valida que el esquema de la BD coincida con las entidades.
    - No crea ni modifica tablas.
    - La responsabilidad de migraciones recae en `Flyway` (buena pr√°ctica en entornos productivos).

- `spring.flyway`
    - `baseline-on-migrate: true` ‚Üí Permite inicializar la base de datos con una versi√≥n base cuando ya existen tablas.
    - `validate-on-migrate: true` ‚Üí Verifica que las migraciones aplicadas coincidan con el historial esperado.
    - `enabled: true` ‚Üí Activa `Flyway` en la aplicaci√≥n.
    - `locations: classpath:db/migration` ‚Üí Carpeta donde se ubican los scripts SQL de migraci√≥n.
    - `baseline-description: 'init'` ‚Üí Descripci√≥n de la versi√≥n inicial.
    - `baseline-version: 0` ‚Üí Define la versi√≥n base de la migraci√≥n.

## üõ†Ô∏è Creando archivos SQL para usar con Flyway

> **‚ö†Ô∏è Nota.** En el siguiente repositorio tambi√©n se hace uso de Flyway:
> [microservices-e-commerce](https://github.com/magadiflo/microservices-e-commerce/tree/main/business-domain/product-service)

Cuando agregamos la dependencia de `Flyway` desde `Spring Initializr`, autom√°ticamente se crea el directorio:
`src/main/resources/db/migration`. Dentro de este directorio colocaremos todos los scripts `.sql` que `Flyway`
ejecutar√° en orden secuencial.

üëâ Importante:
> Aunque usamos `JPA/Hibernate`, la configuraci√≥n `ddl-auto: validate` hace que `Hibernate` solo `valide el esquema`
> existente contra las entidades, pero `no lo cree ni lo actualice`. La responsabilidad de crear y evolucionar la base
> de datos recae en `Flyway`, lo cual es la pr√°ctica recomendada en entornos productivos.

### üìë Convenci√≥n de nombres en Flyway

`Flyway` utiliza una `convenci√≥n estricta de nombres` para identificar y ejecutar las migraciones en orden.
Cada archivo debe seguir el formato:

````bash
V<versi√≥n>__<descripcion>.sql 
````

- `V` ‚Üí Indica que es una migraci√≥n de versi√≥n (Versioned Migration).
- `<versi√≥n>` ‚Üí N√∫mero incremental que define el orden de ejecuci√≥n (ejemplo: 1, 2, 3 ‚Ä¶).
- `__` (doble guion bajo) ‚Üí Separador obligatorio entre la versi√≥n y la descripci√≥n.
- `<descripcion>` ‚Üí Texto descriptivo en min√∫sculas y con guiones bajos, que explica la acci√≥n del script
  (ejemplo: `create_customers_table`).
- `.sql` ‚Üí Extensi√≥n del archivo, ya que `Flyway` ejecuta directamente scripts `SQL`.

````bash
V1__create_customers_table.sql
V2__create_accounts_table.sql
V3__create_transactions_table.sql
````

### üìÑ Script: V1__create_customers_table.sql

Ruta del archivo:

````bash
src/main/resources/db/migration/V1__create_customers_table.sql
````

````sql
-- V1: Creaci√≥n de la tabla customers
CREATE TABLE customers
(
    id              UUID         NOT NULL DEFAULT gen_random_uuid(),
    document_number VARCHAR(20)  NOT NULL,
    document_type   VARCHAR(10)  NOT NULL,
    first_name      VARCHAR(100) NOT NULL,
    last_name       VARCHAR(100) NOT NULL,
    email           VARCHAR(150) NOT NULL,
    phone           VARCHAR(20)  NOT NULL,
    status          VARCHAR(20)  NOT NULL DEFAULT 'ACTIVE',
    created_at      TIMESTAMP    NOT NULL DEFAULT now(),
    updated_at      TIMESTAMP    NOT NULL DEFAULT now(),

    CONSTRAINT pk_customers PRIMARY KEY (id),
    CONSTRAINT uq_customers_document_number UNIQUE (document_number),
    CONSTRAINT uq_customers_email UNIQUE (email),
    CONSTRAINT chk_customers_document_type CHECK (document_type IN ('DNI', 'RUC', 'PASAPORTE')),
    CONSTRAINT chk_customers_status CHECK (status IN ('ACTIVE', 'INACTIVE', 'BLOCKED'))
);

-- √çndices para b√∫squedas frecuentes
-- Nota: document_number y email ya tienen √≠ndices por sus restricciones UNIQUE
CREATE INDEX idx_customers_status ON customers (status);

COMMENT
ON TABLE customers IS 'Tabla de clientes del banco';
COMMENT
ON COLUMN customers.id IS 'Identificador √∫nico del cliente';
COMMENT
ON COLUMN customers.document_number IS 'N√∫mero de documento de identidad';
COMMENT
ON COLUMN customers.document_type IS 'Tipo de documento: DNI, RUC, PASAPORTE';
COMMENT
ON COLUMN customers.status IS 'Estado del cliente: ACTIVE, INACTIVE, BLOCKED';
````

### üìÑ Script: V2__create_accounts_table.sql

Ruta del archivo:

````bash
src/main/resources/db/migration/V2__create_accounts_table.sql
````

````sql
-- V2: Creaci√≥n de la tabla accounts
CREATE TABLE accounts
(
    id             BIGSERIAL      NOT NULL,                        --Clave interna(PK): usado para joins, FK en otras tablas, √≠ndices, etc.
    account_number VARCHAR(20)    NOT NULL,                        --Referencia de negocio, la que viaja en la API, URLs, respuestas JSON
    customer_id    BIGINT         NOT NULL,                        --FK hacia customers.id
    account_type   VARCHAR(20)    NOT NULL,
    balance        DECIMAL(19, 2) NOT NULL DEFAULT 0.00,
    currency       VARCHAR(3)     NOT NULL DEFAULT 'PEN',
    status         VARCHAR(20)    NOT NULL DEFAULT 'ACTIVE',
    created_at     TIMESTAMP      NOT NULL DEFAULT now(),
    updated_at     TIMESTAMP      NOT NULL DEFAULT now(),

    CONSTRAINT pk_accounts PRIMARY KEY (id),                       -- PK crea √≠ndice √∫nico autom√°ticamente
    CONSTRAINT uq_accounts_account_number UNIQUE (account_number), -- UNIQUE crea √≠ndice √∫nico autom√°ticamente

    -- ON DELETE RESTRICT: Impide borrar un cliente si existen cuentas asociadas que lo referencian.
    -- Garantiza la integridad referencial.
    -- Nota: es muy parecido a NO ACTION (que es el valor por defecto), pero la diferencia es que RESTRICT
    -- valida inmediatamente la restricci√≥n en el momento de ejecutar la sentencia, mientras que NO ACTION
    -- espera hasta el final de la transacci√≥n para comprobarla.
    CONSTRAINT fk_accounts_customer FOREIGN KEY (customer_id)
        REFERENCES customers (id) ON DELETE RESTRICT,

    CONSTRAINT chk_accounts_balance CHECK (balance >= 0),
    CONSTRAINT chk_accounts_account_type CHECK (account_type IN ('SAVINGS', 'CHECKING')),
    CONSTRAINT chk_accounts_currency CHECK (currency IN ('PEN', 'USD', 'EUR')),
    CONSTRAINT chk_accounts_status CHECK (status IN ('ACTIVE', 'INACTIVE', 'BLOCKED', 'CLOSED'))
);

-- √çndices para b√∫squedas frecuentes
CREATE INDEX idx_accounts_customer_id ON accounts (customer_id); -- FK no crea √≠ndice autom√°tico
CREATE INDEX idx_accounts_status ON accounts (status); -- √∫til para filtrar cuentas por estado

COMMENT
ON TABLE accounts IS 'Tabla de cuentas bancarias';
COMMENT
ON COLUMN accounts.id IS 'Primary Key: usado para joins, FK, √≠ndices, etc.';
COMMENT
ON COLUMN accounts.account_number IS 'Referencia de negocio, la que viaja en la API, URLs, respuestas JSON';
COMMENT
ON COLUMN accounts.customer_id IS 'Cliente propietario de la cuenta (FK hacia customers.id)';
COMMENT
ON COLUMN accounts.account_type IS 'Tipo de cuenta: SAVINGS (ahorros), CHECKING (corriente)';
COMMENT
ON COLUMN accounts.balance IS 'Saldo actual de la cuenta con 2 decimales';
COMMENT
ON COLUMN accounts.currency IS 'Moneda de la cuenta: PEN, USD, EUR';
COMMENT
ON COLUMN accounts.status IS 'Estado: ACTIVE, INACTIVE, BLOCKED, CLOSED';
````
